name: "Terraform"

on:
   push:
      branches:
         - main
   pull_request:
      branches:
         - main

env:
   TF_VAR_project: ${{ secrets.PROJECT }}
   TF_VAR_credentials_file: ${{ secrets.CREDENTIALS }}

jobs:
   terraform:
      name: "Terraform"
      runs-on: ubuntu-latest
      defaults:
         run:
            shell: bash
            working-directory: ./terraform

      steps:
         - name: Checkout
           uses: actions/checkout@v2

         - name: Setup terraform
           uses: hashicorp/setup-terraform@v1

         - name: Initialize Terraform
           run: |
              terraform init \
                -backend-config="bucket=tf-state-prod" \
                -backend-config="prefix=terraform/state" \

         - name: Terraform Format
           run: terraform fmt -check

         - name: Terraform Plan
           run: terraform plan -input=false

         - name: Terraform Apply
           if: github.ref == 'refs/heads/main'
           run: terraform apply -auto-approve -input=false
